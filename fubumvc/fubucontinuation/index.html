
<!doctype html>
<html lang="en">
  <head>
    <title>
      FubuMVC - Redirects and Filters with FubuContinuation</title>
    
<meta charset="utf-8"/>
<meta name="description" content="FubuDocs"/>
<meta name="author" content="FubuDocs"/>




<link href="/_content/styles/sons-of-obsidian.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/toastr.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/twitter/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/twitter/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/toastr-responsive.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/fubudocs.core.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/fubudocs.theme.css" rel="stylesheet" type="text/css" />

<link media="screen" type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Oswald:400,300">

    
  </head>
  <body data-spy="scroll" data-target=".bs-docs-sidebar" position="relative">
      
    <div class="container">
      
      

<div class="row">
  <div class="span6">
    <p class="logo">
      <a href="/topics" title="Fubu" class="root-link"><span>Fubu</span></a>
      <a href="/fubumvc" title="The .Net web development framework that gets out of your way" class="project-logo"><span>FubuMVC</span></a>
    </p>
  </div>
  <div class="span6">
    <div class="top-header text-right">
      <em>
        <em><a href="https://groups.google.com/forum/?fromgroups#!forum/fubumvc-devel">Join our vibrant mailing list</a></em>
      </em>
      <div class="social">
        <a href="http://github.com/DarthFubuMVC/FubuMVC" class="ico-github"><img alt="Github" src="/_content/images/github-icon.png" /></a>
      </div>
    </div>
  </div>
</div>
      

      <div id="nav-follow" class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <ul class="nav"><li><a href="/fubumvc/index" data-key="index">FubuMVC &#187;</a></li><li class="active"><a href="/fubumvc/fubucontinuation" data-key="fubucontinuation">Redirects and Filters with FubuContinuation &#187;</a></li></ul>
<ul class="nav" style="float:right"><li><a href="/fubumvc/urls-and-routes" title="Urls and Routes">Previous</a></li><li><a href="/fubumvc/partial-requests" title="Partial Requests">Next</a></li></ul>
          </div>
        </div>
      </div>
      <hr/>
      <div class="row">
        
        

        <div class="row">
          <div class="span3 sidebar" data-spy="affix" data-offset-top="150" data-offset-bottom="200">
            
            <h3 class="half-margin">Topics</h3>
            <ul id="page-toc" class="nav nav-tabs nav-stacked bs-docs-sidebar">
            </ul>
            <br/>
            <h3>
              FubuMVC v1.0.0.0
            </h3>

            <br/>
            <h3 class="no-margin">Next</h3>
<p><a href="/fubumvc/partial-requests" data-key="partial-requests">Partial Requests</a></p>
<h3 class="no-margin">Previous</h3>
<p><a href="/fubumvc/urls-and-routes" data-key="index">Urls and Routes</a></p>
          </div>
          <div class="span9">

              <h1 class="no-margin">Redirects and Filters with FubuContinuation</h1>
              <hr class="header-line topic-line"></hr>

            <!--Title: Redirects and Filters with FubuContinuation-->
<!--Url: fubucontinuation-->
<p><section><h4 id="fubucontinuation" class="section-header">FubuContinuation</h4></p>

<p>You'll inevitably need conditional execution in your FubuMVC endpoints.  Whether to render a 404 message if something cannot be found, return validation
messages on validation failures, or redirect the user to an entirely different page if certain conditions are met.</p>

<p>To that end, we introduced the special <code><a href="https://github.com/DarthFubuMVC/fubumvc/blob/master/src/FubuMVC.Core/Continuations/FubuContinuation.cs">FubuContinuation</a></code> class and the much more rarely used <a href="https://github.com/DarthFubuMVC/fubumvc/blob/master/src/FubuMVC.Core/Continuations/IContinuationDirector.cs">IContinuationDirector</a>.</p>

<p>Jumping right to a sample shown below, if a user navigates to <em>/directions</em>, they'll be redirected to one Url if they are a special customer
and redirected to a page for normal customers otherwise.</p>

<pre data-linenums="27" class="prettyprint lang-cs">
        public FubuContinuation get_directions()
        {
            var customer = determineCustomer();
            return customer.IsSpecial()
                ? FubuContinuation.RedirectTo(new SpecialCustomer {Id = customer.Id})
                : FubuContinuation.RedirectTo(new NormalCustomer {Id = customer.Id});
        }
</pre>

<p>By just returning a <code>FubuContinuation</code> from our action above, we've declared <em>what</em> we want to happen next in a way that's easy to measure and detect in unit tests. 
FubuMVC will add an extra behavior into your chain right behind any Action (or ActionFilter introduced below) that will carry out the actual continuation
logic.</p>

<p><code>FubuContinuation</code> provides semantics to:</p>

<ol>
<li>Issue an HTTP 302 redirect to a different Url using FubuMVC's url resolution to either an action method or an input model object</li>
<li><em>Jump the tracks</em> (Transfer) and run a completely different chain inline <em>as a partial</em> in the current request instead of continuing to the inner behavior</li>
<li>Continue normally to the next or inner behavior </li>
<li>End the current request with an Http status code</li>
</ol>

<p>Any time you abort the current chain with a FubuContinuation, the execution still comes back up through the outer behaviors. 
For example, let's say that you are executing a request that has the <code>TransactionalBehavior</code> behavior shown below
that wraps an inner action that returns a <code>FubuContinuation</code>:</p>

<pre data-linenums="335" class="prettyprint lang-cs">
    public class TransactionalBehavior : WrappingBehavior
    {
        protected override void invoke(Action action)
        {
            using (var tx = start())
            {
                // Call the inner behavior, which itself may
                // be executing a FubuContinuation.TransferTo()
                action();
                tx.Commit();
            }
        }

        private Transaction start()
        {
            return new Transaction();
        }
    }
</pre>

<p>The sequence of events is going to be something like:
1. <code>TransactionalBehavior</code> starts a new transaction
1. The inner behaviors process a <code>FubuContinuation.TransferTo()</code> that executes a whole other chain as a partial
1. The execution comes back up through  <code>TransactionalBehavior</code> where it commits the original transaction.</p>

<p></section></p>

<p><section><h4 id="action-filter" class="section-header">ActionFilter</h4></p>

<p>Consistent with FubuMVC's <em>one model in, one model out</em> philosophy, we recommend using a special kind of <em>Action</em> called an <code>ActionFilter</code>
that optionally takes in a single parameter resolved by content negotiation and always returns a <code>FubuContinuation</code>.</p>

<p>Let's say that we're building a FubuMVC frontend on top of some old COBOL like system that will frequently be taken completely down
for maintenance.  If the backend system is down, we'll redirect all of our FubuMVC pages to a notice that the system is offline.</p>

<p>Our <code>ActionFilter</code> class might look like this:</p>

<pre data-linenums="275" class="prettyprint lang-cs">
    public class OfflineFilter
    {
        private readonly IOfflineDetector _detector;

        // You can use constructor injection from your
        // IoC container for dependencies
        public OfflineFilter(IOfflineDetector detector)
        {
            _detector = detector;
        }

        // ActionFilter methods can accept an input message
        public FubuContinuation Filter()
        {
            return _detector.IsOffline()
                ? FubuContinuation.RedirectTo&lt;OfflineEndpoint&gt;(x =&gt; x.get_offline())
                : FubuContinuation.NextBehavior();
        }
    }

    public interface IOfflineDetector
    {
        bool IsOffline();
    }

    public class OfflineEndpoint
    {
        public string get_offline()
        {
            return &quot;We&#39;re offline for maintenance for some reason&quot;;
        }
    }
</pre>

<p>To apply an <code>ActionFilter</code> as a convention, you would write something like the following:</p>

<pre data-linenums="310" class="prettyprint lang-cs">
    public class OfflineFilterPolicy : Policy
    {
        public OfflineFilterPolicy()
        {
            Where.RespondsToHttpMethod(&quot;GET&quot;);

            ModifyBy(chain =&gt; {
                chain.InsertFirst(ActionFilter.For&lt;OfflineFilter&gt;(x =&gt; x.Filter()));    
            });
        }
    }

    // You would add the Policy above to the application&#39;s
    // FubuRegistry class
    public class MyOfflineFubuRegistry : FubuRegistry
    {
        public MyOfflineFubuRegistry()
        {
            Policies.Add&lt;OfflineFilterPolicy&gt;();
        }
    }
</pre>

<p>The <a href="https://github.com/DarthFubuMVC/FubuMVC.Authentication/blob/master/src/FubuMVC.Authentication/AuthenticationFilter.cs">AuthenticationFilter</a> class from FubuMVC.Authentication
that redirects users to login screens or continues to a screen or service depending on authentication state is an example of an <code>ActionFilter</code>.
</section></p>

<p><section><h4 id="filter-attribute" class="section-header">Using the [Filter] Attribute</h4></p>

<p>To date, most <code>ActionFilter</code> usage has been applied to chains within the system conventionally,
but if you do need to apply an <code>ActionFilter</code> behavior explicitly to just one chains you have the
<code>[Filter]</code> attribute to use on action methods that you want to be wrapped with an <code>ActionFilter</code>:</p>

<pre data-linenums="65" class="prettyprint lang-cs">
    public class FilterTargetEndpoint
    {
        [Filter(typeof(ValidFilter))]
        public string get_hello()
        {
            return &quot;Hello&quot;;
        }
    }

    // Note that the ValidFilter only has one method
    // that returns a FubuContinuation
    public class ValidFilter
    {
        public FubuContinuation Filter()
        {
            return FubuContinuation.NextBehavior();
        }
    }
</pre>

<p>The only rule for the <code>[Filter]</code> attribute resolution is that the handler method should have only one public method.
</section></p>

<p><section><h4 id="big-example" class="section-header">Putting it All Together</h4></p>

<p>For a more complex, but very contrived, example, let's say that we have an action that takes in a <code>Number</code> message
and just tells the user what the number really was:</p>

<pre data-linenums="194" class="prettyprint lang-cs">
    public class NumberEndpoint
    {
        [Filter(typeof(NumberFilter))]
        public string get_number_Value(Number number)
        {
            return &quot;The number is &quot; + number.Value;
        }

        public string get_doubled_Value(DoubleNumber number)
        {
            return &quot;The doubled number is &quot; + number.Value;
        }

        public string get_special()
        {
            return &quot;Five is a special number!&quot;;
        }

        public string get_invalid()
        {
            return &quot;The number is invalid!&quot;;
        }
    }

    public class Number
    {
        public int Value { get; set; }
    }

    public class DoubleNumber
    {
        public int Value { get; set; }

        // Note that I had to implement an Equals()
        // method on DoubleNumber for the testing to work
        protected bool Equals(DoubleNumber other)
        {
            return Value == other.Value;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj)) return false;
            if (ReferenceEquals(this, obj)) return true;
            if (obj.GetType() != this.GetType()) return false;
            return Equals((DoubleNumber) obj);
        }

        public override int GetHashCode()
        {
            return Value;
        }
    }
</pre>

<p>However, we want to treat some numbers as special cases and render different messages or pop into entirely different workflows.
As explained in the previous section, we can place all the conditional redirection logic in an <code>ActionFilter</code> action
method:</p>

<pre data-linenums="70" class="prettyprint lang-cs">
            using (var server = FubuApplication
                .DefaultPolicies()
                .StructureMap()
                .RunEmbedded(port:PortFinder.FindPort(5500)))
            {
                // Proceed as normal through the chain
                server.Endpoints.GetByInput(new Number {Value = 1})
                    .ReadAsText().ShouldEqual(&quot;The number is 1&quot;);

                // 5 is special, &quot;jump the tracks&quot; and execute
                // a different chain inline
                server.Endpoints.GetByInput(new Number {Value = 5})
                    .ReadAsText().ShouldEqual(&quot;Five is a special number!&quot;);

                // You are not authorized to specify a number greater
                // than 10
                server.Endpoints.GetByInput(new Number {Value = 11})
                    .StatusCode
                    .ShouldEqual(HttpStatusCode.Unauthorized);

                // Negative numbers are invalid, so we&#39;ll redirect
                // the user to another page instead
                server.Endpoints.GetByInput(new Number {Value = -1})
                    .ReadAsText().ShouldEqual(&quot;The number is invalid!&quot;);

                // You can also redirect or transfer by the input model
                // to the other chain
                server.Endpoints.GetByInput(new Number {Value = 2})
                    .ReadAsText().ShouldEqual(&quot;The doubled number is 4&quot;);

                server.Endpoints.GetByInput(new Number { Value = 4 })
                    .ReadAsText().ShouldEqual(&quot;The doubled number is 8&quot;);
            }
</pre>

<p></section></p>

<p><section><h4 id="unit-testing" class="section-header">Unit Testing against FubuContinuation</h4>
<code>FubuContinuation</code> was specifically designed to make unit testing easier by allowing you to do state-based
assertions against the value of a <code>FubuContinuation</code> returned from an action filter method like this:</p>

<pre data-linenums="140" class="prettyprint lang-cs">
    [TestFixture]
    public class NumberFilterTester
    {
        [Test]
        public void just_go_on_if_not_a_special_number()
        {
            new NumberFilter()
                .Filter(new Number{Value = 1})
                .AssertWasContinuedToNextBehavior();
        }

        [Test]
        public void stop_if_greater_than_10()
        {
            new NumberFilter()
                .Filter(new Number{Value = 11})
                .AssertWasEndedWithStatusCode(HttpStatusCode.Unauthorized);
        }

        [Test]
        public void redirect_if_a_negative_number()
        {
            new NumberFilter()
                .Filter(new Number{Value = -1})
                .AssertWasRedirectedTo&lt;NumberEndpoint&gt;(x =&gt; x.get_invalid());
        }

        [Test]
        public void transfer_to_special_if_5()
        {
            new NumberFilter()
                .Filter(new Number{Value = 5})
                .AssertWasTransferedTo&lt;NumberEndpoint&gt;(x =&gt; x.get_special());
        }

        [Test]
        public void transfer_if_2()
        {
            new NumberFilter()
                .Filter(new Number{Value = 2})
                .AssertWasTransferedTo(new DoubleNumber{Value = 4});
        }

        [Test]
        public void redirect_if_4()
        {
            new NumberFilter()
                .Filter(new Number { Value = 4 })
                .AssertWasRedirectedTo(new DoubleNumber { Value = 8 });
        }
    }
</pre>

<div class="alert alert-info"><i class="icon-info-sign"></i>Note that you will have to implement an <code>Equals()</code> method on any input model types you use in the assertion methods</div>

<p></section></p>

<p><section><h4 id="redirectable" class="section-header">IRedirectable</h4></p>

<p>If you do want to combine the filtering logic into a normal action method similar to <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.actionresult(v=vs.118).aspx">ActionResult's</a> in ASP.Net MVC, you can make
your output model from an action implement the <code>IRedirectable</code> interface like this sample:</p>

<pre data-linenums="251" class="prettyprint lang-cs">
    public class RedirectingNumber : Number{}

    public class RedirectableEndpoint
    {
        public RedirectableNumber get_redirectable(RedirectingNumber number)
        {
            return new RedirectableNumber
            {
                Number = number.Value,
                RedirectTo = number.Value &lt; 0 
                    ? FubuContinuation.TransferTo&lt;NumberEndpoint&gt;(x =&gt; x.get_invalid()) 
                    : null
            };
        }
    }

    public class RedirectableNumber : IRedirectable
    {
        public int Number { get; set; }
        public FubuContinuation RedirectTo { get; set; }
    }
</pre>

<p></section></p>







          </div>
        </div>
      </div>
    </div>

    <br></br>
    <hr></hr>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <ul class="nav"><li><a href="/fubumvc/index" data-key="index">FubuMVC &#187;</a></li><li class="active"><a href="/fubumvc/fubucontinuation" data-key="fubucontinuation">Redirects and Filters with FubuContinuation &#187;</a></li></ul>
<ul class="nav" style="float:right"><li><a href="/fubumvc/urls-and-routes" title="Urls and Routes">Previous</a></li><li><a href="/fubumvc/partial-requests" title="Partial Requests">Next</a></li></ul>
        </div>
      </div>
    </div>
    
    
    

<script type="text/javascript" src="/_content/scripts/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="/_content/scripts/prettify.js"></script>
<script type="text/javascript" src="/_content/scripts/bootstrap-prettify.js"></script>
<script type="text/javascript" src="/_content/scripts/fubudocs.js"></script>
<script type="text/javascript" src="/_content/scripts/jquery.nestable.js"></script>
<script type="text/javascript" src="/_content/scripts/toastr.js"></script>
<script type="text/javascript" src="/_content/scripts/twitter/bootstrap.min.js"></script>
<script type="text/javascript" src="/_content/scripts/diagnostics/bootstrap-scrollspy.js"></script>
<script type="text/javascript" src="/_content/scripts/fubudocs-tools.js"></script>
<script type="text/javascript" src="/_content/scripts/twitter/bootstrap-affix.js"></script>
<script type="text/javascript" src="/_content/scripts/topics.js"></script>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
    </p>
    <p>
      Powered by <a href="http://github.com/DarthFubuMVC/FubuDocs">FubuDocs</a>.
    </p>
  </div>
</footer>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <title>
      FubuMVC - Working with Authorization Policies</title>
    
<meta charset="utf-8"/>
<meta name="description" content="FubuDocs"/>
<meta name="author" content="FubuDocs"/>




<link href="/_content/styles/sons-of-obsidian.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/toastr.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/twitter/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/twitter/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/toastr-responsive.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/fubudocs.core.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/fubudocs.theme.css" rel="stylesheet" type="text/css" />

<link media="screen" type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Oswald:400,300">
  </head>
  <body data-spy="scroll" data-target=".bs-docs-sidebar">
      
    <div class="container">
      
      

<div class="row">
  <div class="span6">
    <p class="logo">
      <a href="/topics" title="Fubu" class="root-link"><span>Fubu</span></a>
      <a href="/fubumvc" title="The MVC framework that gets out of your way" class="project-logo"><span>FubuMVC</span></a>
    </p>
  </div>
  <div class="span6">
    <div class="top-header text-right">
      <em>
        <em><a href="https://groups.google.com/forum/?fromgroups#!forum/fubumvc-devel">Join our vibrant mailing list</a></em>
      </em>
      <div class="social">
        <a href="http://github.com/DarthFubuMVC/FubuMVC" class="ico-github"><img alt="Github" src="/_content/images/github-icon.png" /></a>
      </div>
    </div>
  </div>
</div>
      

      <div id="nav-follow" class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <ul class="nav"><li><a href="/fubumvc" data-key="index">FubuMVC &#187;</a></li><li><a href="/fubumvc/topics/authorization" data-key="index">Authorization &#187;</a></li><li class="active"><a href="/fubumvc/topics/authorization/working-with-authorization-policies" data-key="working-with-authorization-policies">Working with Authorization Policies &#187;</a></li></ul>
<ul class="nav" style="float:right"><li><a href="/fubumvc/topics/authorization/allow-role" title="Know your role">Previous</a></li><li><a href="/fubumvc/topics/service-registration" title="Bootstrapping and Service Registration">Next</a></li></ul>
          </div>
        </div>
      </div>
      <hr/>
      <div class="row">
        
        

        <div class="row">
          <div class="span3 sidebar">
            
            <h3 class="half-margin">Topics</h3>
            <ul id="page-toc" class="nav nav-tabs nav-stacked affix">
            </ul>
            <br/>
            <h3>
              FubuMVC v1.0.0.0
            </h3>

            <br/>
            <h3 class="no-margin">Next</h3>
<p><a href="/fubumvc/topics/service-registration" data-key="service-registration">Bootstrapping and Service Registration</a></p>
<h3 class="no-margin">Previous</h3>
<p><a href="/fubumvc/topics/authorization/allow-role" data-key="allow-role">Know your role</a></p>
          </div>
          <div class="span9">

              <h1 class="no-margin">Working with Authorization Policies</h1>
              <hr class="header-line topic-line"></hr>

            <!--Title: Working with Authorization Policies-->
<!--Url: working-with-authorization-policies-->
<p>There may be situations where determining authorization based on role is not
enough. FubuMVC provides ways to define custom rules that can easily be hooked
into the authorization pipeline.</p>

<h2>Rolling with a custom authorization policy</h2>

<p>When will defining a custom policy be useful?  Let's say, for example, a
customer can only post a review for products they have purchased in the past.
It would make sense to look at the purchase history of the customer to determine
if they are authorized to make a review. </p>

<p>The policy will retrieve a customer's purchase history and determine if any of
the purchases previously made contains the product in question. If the customer
has not yet made the purchase, they will be denied to execute the action;
otherwise, they will be allowed to proceed.</p>

<pre data-linenums="9" class="prettyprint lang-cs">
    public class PurchasedProductPolicy : IAuthorizationPolicy
    {
        readonly IRepository _repository;

        public PurchasedProductPolicy(IRepository repository)
        {
            _repository = repository;
        }

        public AuthorizationRight RightsFor(IFubuRequest request)
        {
            var customerId = request.Get&lt;Customer&gt;().Id;
            var productId = request.Get&lt;Product&gt;().Id;

            var hasPurchasedProduct = _repository.Get&lt;IPurchaseHistory&gt;(customerId)
                .Any(x =&gt; x.ContainsProduct(productId));

            return !hasPurchasedProduct ? AuthorizationRight.Deny : AuthorizationRight.Allow;
        }
    }
</pre>

<h2>Wiring it up</h2>

<p>One way of wiring it up is to use the AuthorizedByAttribute, which takes in
array of policy types. If any of the types do not implement
IAuthorizationPolicy, then an exception will be thrown.</p>

  <div class="alert alert-info"><i class="icon-info-sign"></i>
    The AuthorizedByAttribute also allows for types that implement
    IAuthorizationRule<> which will be discussed later.</div>

  <div class="alert alert-info"><i class="icon-info-sign"></i>
    The attribute can be applied at class level as well.</div>

<p>Example usage:</p>

<pre data-linenums="6" class="prettyprint lang-cs">
    public class ProductController
    {
        [AuthorizedBy(typeof(PurchasedProductPolicy))]
        public void SaveReview(ReviewInputModel input)
        {
            //logic
        }
    }
</pre>

<p>Of course, the more preferred way of doing things is to apply it as a convention
through a behavior chain policy.</p>

<pre data-linenums="8" class="prettyprint lang-cs">
  public class PurchasedProductAuthorizationPolicy : IConfigurationAction
  {
      public void Configure(BehaviorGraph graph)
      {
          graph.Actions()
              .Where(x =&gt; x.Method.Name.EndsWith(&quot;Review&quot;))
              .Each(x =&gt; x.ParentChain().Authorization.AddPolicy(typeof(PurchasedProductPolicy)));
      }
  }
</pre>



          </div>
        </div>
      </div>
    </div>

    

<script type="text/javascript" src="/_content/scripts/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="/_content/scripts/prettify.js"></script>
<script type="text/javascript" src="/_content/scripts/bootstrap-prettify.js"></script>
<script type="text/javascript" src="/_content/scripts/fubudocs.js"></script>
<script type="text/javascript" src="/_content/scripts/jquery.nestable.js"></script>
<script type="text/javascript" src="/_content/scripts/toastr.js"></script>
<script type="text/javascript" src="/_content/scripts/twitter/bootstrap.min.js"></script>
<script type="text/javascript" src="/_content/scripts/fubudocs-tools.js"></script>
<script type="text/javascript" src="/_content/scripts/twitter/bootstrap-affix.js"></script>
<script type="text/javascript" src="/_content/scripts/topics.js"></script>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
    </p>
    <p>
      Powered by <a href="http://github.com/DarthFubuMVC/FubuDocs">FubuDocs</a>.
    </p>
  </div>
</footer>
  </body>
</html>
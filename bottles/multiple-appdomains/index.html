
<!doctype html>
<html lang="en">
  <head>
    <title>
      Bottles - Multiple AppDomain Support</title>
    
<meta charset="utf-8"/>
<meta name="description" content="FubuDocs"/>
<meta name="author" content="FubuDocs"/>




<link href="/_content/styles/sons-of-obsidian.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/toastr.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/twitter/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/twitter/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/toastr-responsive.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/fubudocs.core.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/fubudocs.theme.css" rel="stylesheet" type="text/css" />

<link media="screen" type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Oswald:400,300">

    
  </head>
  <body data-spy="scroll" data-target=".bs-docs-sidebar" position="relative">
      
    <div class="container">
      
      

<div class="row">
  <div class="span6">
    <p class="logo">
      <a href="/topics" title="Fubu" class="root-link"><span>Fubu</span></a>
      <a href="/bottles" title="A member of the Fubu family of projects" class="project-logo"><span>Bottles</span></a>
    </p>
  </div>
  <div class="span6">
    <div class="top-header text-right">
      <em>
        <em><a href="https://groups.google.com/forum/?fromgroups#!forum/fubumvc-devel">Join our vibrant mailing list</a></em>
      </em>
      <div class="social">
        <a href="http://github.com/DarthFubuMVC/Bottles" class="ico-github"><img alt="Github" src="/_content/images/github-icon.png" /></a>
      </div>
    </div>
  </div>
</div>
      

      <div id="nav-follow" class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <ul class="nav"><li><a href="/bottles" data-key="index">Bottles &#187;</a></li><li class="active"><a href="/bottles/multiple-appdomains" data-key="multiple-appdomains">Multiple AppDomain Support &#187;</a></li></ul>
<ul class="nav" style="float:right"><li><a href="/bottles/linking-projects" title="Linking Projects">Previous</a></li><li><a href="/bottles/event-aggregation" title="Event Aggregation">Next</a></li></ul>
          </div>
        </div>
      </div>
      <hr/>
      <div class="row">
        
        

        <div class="row">
          <div class="span3 sidebar" data-spy="affix" data-offset-top="150" data-offset-bottom="200">
            
            <h3 class="half-margin">Topics</h3>
            <ul id="page-toc" class="nav nav-tabs nav-stacked bs-docs-sidebar">
            </ul>
            <br/>
            <h3>
              Bottles v0.0.0.0
            </h3>

            <br/>
            <h3 class="no-margin">Next</h3>
<p><a href="/bottles/event-aggregation" data-key="event-aggregation">Event Aggregation</a></p>
<h3 class="no-margin">Previous</h3>
<p><a href="/bottles/linking-projects" data-key="linking-projects">Linking Projects</a></p>
          </div>
          <div class="span9">

              <h1 class="no-margin">Multiple AppDomain Support</h1>
              <hr class="header-line topic-line"></hr>

            <!--Title: Multiple AppDomain Support-->
<!--Url: multiple-appdomains-->
<p>Say that you're working with distributed applications where you expect a single logical business process to be implemented across multiple related applications and services. 
Even with an effective testing strategy for each individual service in isolation, we still need to work with the entire distributed stack to test and troubleshoot some issues -- and yes, sometimes that's going to mean attaching a debugger to one or all of the elements of the distributed architecture.</p>

<p>To combat the difficulty of debugging distributed applications and create a faster development cycle, we've created what we call the <em>F5 in a box</em> strategy with Bottles to run a distributed application in a single process but using multiple .Net AppDomain's to host additional services. </p>

<p>The canonical example is developing a front end website (<em>WebSite1</em>) that offloads heavy and time consuming processing to a separate service (<em>Service1</em>).
With the Bottles features discussed in this topic, we can make the main <em>WebSite1</em> application load a separate AppDomain to run the <em>Service1</em> service on application startup.
The end result is a faster feedback cycle between making code changes in any part of the architecture and exercising those changes because a single action restarts the entire application.
Debugging becomes much simpler because you're in one single process and you effectively attach the debugger to both <em>WebSite1</em> and <em>Service1</em> with a single press of the <em>F5</em> key.</p>

<p><section><h4 id="remote-links" class="section-header">Remote Links</h4>
After using early versions of a <em>F5 in a box</em> that used the <code>RemoteServiceRunner</code> discussed below directly in <a href="/fubumvc">FubuMVC</a> applications, we learned some lessons about the usage and development experience that led to the new <em>remote links</em> function.
The key features of <em>remote links</em> are:</p>

<ol>
<li>Remote links (what folder and possibly an explicit bootstrapper class and/or a configuration file) are stored in the <code>.links</code> file at the application root</li>
<li>If this file exists, Bottles will load a separate AppDomain for each <em>remote link</em> in <strong>parallel</strong> with the main application's bootstrapping for a quicker feedback cycle in development (loading the main application and all of the remote AppDomain's serially was painfully slow).</li>
<li>To facilitate easier changes, the remote AppDomain's are all setup with <strong><a href="http://msdn.microsoft.com/en-us/library/ms404279(v=vs.110).aspx">shadow copying</a> enabled</strong>. Bottles watches for file system changes to <code>.config</code> and <code>.dll</code> files and will attempt to shutdown and reload the AppDomain if any changes are detected.  This allows a developer to modify the remote services without having to shutdown the staring application.</li>
</ol>

<div class="alert alert-info"><i class="icon-info-sign"></i>Generally, you would ignore the <code>.links</code> file in source control to prevent that file from being deployed to production.  Using the ignored file at development time allows you to use _remote links_ without having to change your application.</div>

<p><em>Remote Links</em> can be setup using the <code>bottles link</code> command with the <code>--remote</code> flag.  See <a href="/bottles/commandline/linking" data-key="linking">Linked Project Bottles</a> for more information on using this command.</section></p>

<p><section><h4 id="runner" class="section-header">RemoteServiceRunner</h4>
The underlying class for setting up additional AppDomain's is the <code>RemoteServiceRunner</code> class as shown below:</p>

<pre data-linenums="69" class="prettyprint lang-cs">
            var runner = new RemoteServiceRunner(x =&gt; {
                x.ServiceDirectory = @&quot;c:\code\other-service\src\other-service&quot;;
                x.Setup.ShadowCopyFiles = true.ToString();
            });

            // stop and restart the remote AppDomain
            runner.Recycle();

            // There is support for event aggregation between
            // AppDomain&#39;s for coordination
            runner.SendRemotely(new SomeMessage());

            // Shut down and close the remote AppDomain
            runner.Dispose();

</pre>

<p>The nested closure within the construction of a new <code>RemoteServiceRunner</code> instance allows you to configure how the new AppDomain is going to be loaded:</p>

<pre data-linenums="104" class="prettyprint lang-cs">
            var runner = new RemoteServiceRunner(x =&gt; {

                // ShadowCopyFiles should be either &quot;true&quot; or &quot;false&quot;
                x.Setup.ShadowCopyFiles = true.ToString();

                // RemoteServiceRunner makes some guesses about the
                // PrivateBinPath based on the folders it sees,
                // but once in a while you may want to override
                // the bin path
                x.Setup.PrivateBinPath = &quot;bin&quot;;
            });
</pre>

<p></section></p>

<p><section><h4 id="config" class="section-header">Config Files</h4>
By default, <code>RemoteServiceRunner</code> looks first for the presence of an <code>App.config</code> file, then <code>Web.config</code> in the application folder.  If neither exists, the configuration file is going to be <code>BottleServiceRunner.exe.config</code> (Bottles is assuming that the code is normally hosted by <code>BottleServiceRunner</code>.  This file name can be overridden by setting the configuration file property of the <code>AppDomainSetup</code> like this:</p>

<p><pre data-linenums="42" class="prettyprint lang-cs">
            var runner = new RemoteServiceRunner(x =&gt; {
                x.Setup.ConfigurationFile = &quot;Web.config&quot;;
            });
</pre></section></p>

<p><section><h4 id="assemblies" class="section-header">Copying Assemblies to the Remote AppDomain</h4>
If need be, you can copy assemblies from your main application binaries to the new AppDomain like this:</p>

<p><pre data-linenums="122" class="prettyprint lang-cs">
            var runner = new RemoteServiceRunner(x =&gt; {
                // This line of code will copy the Bottles.dll assembly
                // into the remote AppDomain location
                x.RequireAssemblyContainingType&lt;Bottles.IPackageFacility&gt;();
                x.RequireAssembly(&quot;MyAssembly&quot;);
            });
</pre></section></p>

<p><Section name="Activation" id="activation">
It's pretty useless to just set up a separate AppDomain to do nothing but just sit there, so we need some way for <code>RemoteServiceRunner</code> to reach into the new AppDomain and start up the application or service we want to use.
Bottles can use an instance of one of three interfaces to bootstrap a bottles aware application:</p>

<ol>
<li>IApplicationLoader</li>
<li>IBootstrapper</li>
<li>IApplicationSource (<a href="/fubumvc">FubuMVC</a> and <a href="/fubutransportation">FubuTransportation</a> both use this approach)</li>
</ol>

<p>With <code>RemoteServiceRunner</code>, you can explicitly specify the class that should be called to activate the application in the remote AppDomain like this:</p>

<pre data-linenums="23" class="prettyprint lang-cs">
            var runner = RemoteServiceRunner.For&lt;IApplicationLoader&gt;(x =&gt; {
                // more AppDomain configuration
            });

            // -- or --
            runner = new RemoteServiceRunner(x =&gt; {
                // Can be the assembly qualified name of either:
                // 1. An IApplicationLoader class
                // 2. An IApplicationSource&lt;,&gt; class
                // 3. An IBootstrapper class
                x.BootstrapperName = &quot;MyLib.AppLoader, MyLib&quot;;
            });
</pre>

<p>By default, Bottles will reflect through all the assemblies loaded in the remote AppDomain looking for concrete classes that implement one of the three interfaces above.  <strong>If only one is found, Bottles will use that class automatically.</strong>  So far, the default auto-determination of the loader/bootstrapper class has worked out well in practice.</p>

<p>See <a href="/bottles/bootstrapping" data-key="bootstrapping">Bootstrapping a Bottles Aware Application</a> for more information about using <code>IApplicationLoader</code>, <code>IBootstrapper</code>, or <code>IApplicationSource</code> usage.</p>

<p></Section> </p>







          </div>
        </div>
      </div>
    </div>

    <br></br>
    <hr></hr>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <ul class="nav"><li><a href="/bottles" data-key="index">Bottles &#187;</a></li><li class="active"><a href="/bottles/multiple-appdomains" data-key="multiple-appdomains">Multiple AppDomain Support &#187;</a></li></ul>
<ul class="nav" style="float:right"><li><a href="/bottles/linking-projects" title="Linking Projects">Previous</a></li><li><a href="/bottles/event-aggregation" title="Event Aggregation">Next</a></li></ul>
        </div>
      </div>
    </div>
    
    
    

<script type="text/javascript" src="/_content/scripts/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="/_content/scripts/prettify.js"></script>
<script type="text/javascript" src="/_content/scripts/bootstrap-prettify.js"></script>
<script type="text/javascript" src="/_content/scripts/fubudocs.js"></script>
<script type="text/javascript" src="/_content/scripts/jquery.nestable.js"></script>
<script type="text/javascript" src="/_content/scripts/toastr.js"></script>
<script type="text/javascript" src="/_content/scripts/twitter/bootstrap.min.js"></script>
<script type="text/javascript" src="/_content/scripts/diagnostics/bootstrap-scrollspy.js"></script>
<script type="text/javascript" src="/_content/scripts/fubudocs-tools.js"></script>
<script type="text/javascript" src="/_content/scripts/twitter/bootstrap-affix.js"></script>
<script type="text/javascript" src="/_content/scripts/topics.js"></script>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
    </p>
    <p>
      Powered by <a href="http://github.com/DarthFubuMVC/FubuDocs">FubuDocs</a>.
    </p>
  </div>
</footer>
  </body>
</html>